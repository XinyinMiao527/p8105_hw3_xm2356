---
title: "p8105_hw3_xm2356"
author: "Xinyin Miao (xm2356)"
date: "2025-10-06"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6 )
```

```{r}
library(tidyverse)
library(knitr)
library(patchwork)
```

# Problem 1
```{r}
library(p8105.datasets)
data("instacart")
```

The instacart dataset is a large dataframe containing `r nrow(instacart)` observations and `r ncol(instacart)` variables. Each observation represents a single item within a customer's order. Key variables include:

order_id: A unique identifier for each order.
product_id: A unique identifier for each product.
product_name: The name of the product.
aisle_id and aisle: The aisle number and name where the product is located.
department: The department name.
order_dow: The day of the week the order was placed.
order_hour_of_day: The hour of the day the order was placed.

```{r}
instacart |> 
  summarize(
    total_obs = n(),
    unique_users = n_distinct(user_id),
    unique_orders = n_distinct(order_id),
    unique_aisles = n_distinct(aisle)
  )

```

Take the contents of order ID `r instacart$order_id[1]` as an example. This customer ordered 8 items, including 'Bulgarian Yogurt', which is from the 'yogurt' aisle and 'dairy eggs' department. Within these 8 items, 'Bulgarian Yogurt','Organic 4% Milk Fat Whole Milk Cottage Cheese','Lightly Smoked Sardines in Olive Oil', 'Organic Whole String Cheese' have been ordered by this user in the past. And the order was placed on Friday at 10 a.m.There are 9 days since the last order.

## How many aisles are there, and which aisles are the most items ordered from?

```{r}

unique_aisles = instacart |> 
  summarize(unique_aisles = n_distinct(aisle))

aisle_counts = instacart |> 
  count(aisle, sort = TRUE)

unique_aisles
head(aisle_counts)

```

There are `r unique_aisles` unique aisles in the dataset. The top 5 most ordered-from aisles are "fresh vegetables", "fresh fruits", "packaged vegetables fruits", "yogurt", and "packaged cheese".

## The number of items ordered in each aisle.
```{r}
aisle_counts |> 
  filter(n > 10000) |> 
  mutate(aisle = fct_reorder(aisle, n)) |> 
  ggplot(aes(x = aisle, y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Aisles with >10,000 Orders",
       x = "Aisle", y = "Number of Orders")

```


## The table shows the three most popular items in some of the aisles.
```{r}
instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  count(aisle, product_name, sort = TRUE) |> 
  group_by(aisle) |> 
  slice_max(n, n = 3) |> 
  knitr::kable()

```


## The mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week.
```{r}
instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  group_by(product_name, order_dow) |> 
  summarize(mean_hour = mean(order_hour_of_day)) |> 
  pivot_wider(names_from = order_dow, values_from = mean_hour) |> 
  knitr::kable(digits = 2)

```

The table indicates that, on average, Coffee Ice Cream is ordered later in the day than Pink Lady Apples across all days of the week. Both products tend to be ordered in the early to mid-afternoon (13:00-15:00).


# Problem 2

tidy the data
```{r}
zori_file <- "data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv"
zip_file  <- "data/zillow_data/Zip Codes.csv"

zori_df <- read_csv(zori_file) |> 
  pivot_longer(
    cols = matches("^20"),   
    names_to = "month",
    values_to = "rent" # Renamed to 'rent' for clarity
  ) |> 
  mutate(
    month = ymd(month),      
    year = year(month)
  )

zip_df <- read_csv(zip_file) |> 
  janitor::clean_names() |> 
  distinct(zip_code, .keep_all = TRUE)

# Join the data
zillow_df <- zori_df |> 
  left_join(zip_df, by = c("RegionName" = "zip_code")) |> 
  arrange(RegionName, month) |>

  filter(!is.na(county)) |>
  rename(borough = county, zip_code = RegionName) 

```

## Number of ZIP codes observed

```{r}

total_months <- n_distinct(zillow_df$month)

zip_summary <- zillow_df |>
  count(zip_code) |>
  summarise(
    total_unique_months = total_months,
    zips_observed_all_months = sum(n == total_months),
    zips_observed_rarely = sum(n < 10)
  )

print(zip_summary)
```

## The average rental price in each borough and year
```{r}
avg_rent_table <- zillow_df |>
  group_by(borough, year) |>
  summarise(avg_rent = mean(rent, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = year, values_from = avg_rent)

kable(avg_rent_table, digits = 0)
```

There is a consistent and significant upward trend in rental prices across all boroughs from 2015 to 2024. Most boroughs saw their average rents increase by several hundred dollars over the decade.

New York (Manhattan) is consistently the most expensive borough by a large margin, followed by Kings (Brooklyn), Queens, and then the Bronx.

A noticeable dip or stagnation in rental prices occurred in 2020 and 2021 for most boroughs, including New York, Kings, and Queens. This deviation from the growth trend likely reflects the initial impact of the COVID-19 pandemic on the rental market. The Bronx is a notable exception, as its rent continued to rise steadily during this period.

Beginning in 2022, the market experienced a dramatic surge in rental prices across all boroughs. This indicates a strong and rapid recovery, with rents quickly surpassing pre-pandemic levels.

## NYC Rental Prices

```{r}
plot_rent_ts <- zillow_df |>
  group_by(borough, month) |>
  summarise(avg_rent = mean(rent, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = month, y = avg_rent, color = borough)) +
  geom_line(linewidth = 1) +
  labs(title = "Average Monthly Rental Prices by Borough", x = "Year", y = "Average Rent") +
  theme_minimal()
plot_rent_ts
```

A significant element is that the Bronx and Staten Island do not exhibit the same V-shaped pattern. Instead, their rental prices show a more consistent, steady increase throughout the entire period, without the dramatic dip seen in the other boroughs.

Despite the mid-period volatility for some boroughs, the overall trend for all five is a clear increase in average rental prices from the beginning to the end of the time series shown.

The plot reveals that the data for Staten Island (Richmond) starts later than the other boroughs, around 2020, indicating a shorter observation period for that borough in this dataset.

## The average rental price within each ZIP code over each month in 2023

```{r}
plot_rent_dist <- zillow_df |>
  filter(year == 2023) |>
  group_by(borough, zip_code) |>
  summarise(avg_rent_2023 = mean(rent, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = fct_reorder(borough, avg_rent_2023), y = avg_rent_2023, fill = borough)) +
  geom_boxplot() +
  labs(title = "Distribution of Rental Prices in 2023", x = "Borough", y = "Average Rent") +
  theme_minimal() +
  theme(legend.position = "none")
plot_rent_dist
```

The plot shows a distinct tiered structure in median rental prices. 

Manhattan (New York) has the highest median rent by a significant margin, followed by Brooklyn (Kings), and then Queens. The Bronx and Staten Island (Richmond) have the lowest median rents and are very comparable to each other.

There are major differences in the range of rental prices within each borough. 

Manhattan and Brooklyn display very wide distributions, evidenced by their large boxes and long whiskers. This indicates a substantial price gap between their most and least expensive neighborhoods. In contrast, the Bronx, Queens, and Staten Island have much more compressed distributions, suggesting more uniform rental prices across their respective ZIP codes.

The individual points above the whiskers signify outlier ZIP codes with exceptionally high rents. 

Manhattan has the most numerous and extreme outliers, with some average rents far exceeding $5,000. This highlights the presence of super-premium neighborhoods within the borough. Brooklyn also has several high-priced outliers.

```{r}
if (!dir.exists("results")) dir.create("results")
ggsave("results/zillow_analysis.png", plot_rent_ts / plot_rent_dist, width = 10, height = 8)
```

# Problem 3

tidy the data 
```{r}

nhanes_df <- 
  inner_join(
    read_csv("./data/nhanes_covar.csv", skip = 4),
    read_csv("./data/nhanes_accel.csv"),
    by = "SEQN"
  ) |>
  filter(age >= 21) |>
  drop_na(sex, age, education, BMI) |>
  mutate(
    sex = factor(
      sex,
      levels = c(1, 2),
      labels = c("Male", "Female")
      ),
    education = factor(
      education,
      levels = c(1, 2, 3),
      labels = c("Less than high school", "High school equivalent", "More than high school"),
      ordered = TRUE
    )
  )
```











