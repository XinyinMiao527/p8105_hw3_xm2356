---
title: "p8105_hw3_xm2356"
author: "Xinyin Miao (xm2356)"
date: "2025-10-11"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 8 )

```

```{r}
library(tidyverse)
library(knitr)
library(patchwork)
```

# Problem 1
```{r}
library(p8105.datasets)
data("instacart")
```

```{r}
instacart |> 
  summarize(
    total_obs = n(),
    unique_users = n_distinct(user_id),
    unique_orders = n_distinct(order_id),
    unique_aisles = n_distinct(aisle)
  )

```

The instacart dataset is a large dataframe containing `r nrow(instacart)` observations and `r ncol(instacart)` variables. Each observation represents a single item within a customer's order. Key variables include:

order_id: A unique identifier for each order.
product_id: A unique identifier for each product.
product_name: The name of the product.
aisle_id and aisle: The aisle number and name where the product is located.
department: The department name.
order_dow: The day of the week the order was placed.
order_hour_of_day: The hour of the day the order was placed.

Take the contents of order ID `r instacart$order_id[1]` as an example. This customer ordered 8 items, including 'Bulgarian Yogurt', which is from the 'yogurt' aisle and 'dairy eggs' department. Within these 8 items, 'Bulgarian Yogurt','Organic 4% Milk Fat Whole Milk Cottage Cheese','Lightly Smoked Sardines in Olive Oil', 'Organic Whole String Cheese' have been ordered by this user in the past. And the order was placed on Friday at 10 a.m.There are 9 days since the last order.



## How many aisles are there, and which aisles are the most items ordered from?

```{r}

unique_aisles = instacart |> 
  summarize(unique_aisles = n_distinct(aisle))

aisle_counts = instacart |> 
  count(aisle, sort = TRUE)

unique_aisles
head(aisle_counts)

```

There are `r unique_aisles$unique_aisles` unique aisles in the dataset. The top 5 most ordered-from aisles are "fresh vegetables", "fresh fruits", "packaged vegetables fruits", "yogurt", and "packaged cheese".

## The number of items ordered in each aisle.
```{r}
aisle_counts |> 
  filter(n > 10000) |> 
  mutate(aisle = fct_reorder(aisle, n)) |> 
  ggplot(aes(x = aisle, y = n)) +
  geom_col() +
  coord_flip() +
  labs(title = "Aisles with >10,000 Orders",
       x = "Aisle", y = "Number of Orders")

```

Dominance of Fresh Produce: The most prominent feature is the overwhelming popularity of fresh and packaged produce. The top three aisles—"fresh vegetables," "fresh fruits," and "packaged vegetables fruits"—account for the highest number of orders, with "fresh vegetables" leading at over 150,000 orders. This indicates that customers primarily use Instacart for staples and perishables.

Dairy and Drinks: Following produce, major categories like "yogurt," "packaged cheese," "water seltzer sparkling water," and "milk" rank highly, showing that customers frequently replenish dairy and beverage items.

The distribution shows a steep drop-off after the top few categories. The difference in order volume between the top aisle ("fresh vegetables") and aisles further down the list (e.g., "butter" or "oils vinegars") is substantial, highlighting that a small number of aisles drive the majority of Instacart's item volume.

## The table shows the three most popular items in some of the aisles.
```{r}
instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  count(aisle, product_name, sort = TRUE) |> 
  group_by(aisle) |> 
  slice_max(n, n = 3) |> 
  knitr::kable()

```

Baking Ingredients Dominated by Sweeteners: The most popular items in the "baking ingredients" aisle are "Light Brown Sugar," "Pure Baking Soda," and "Cane Sugar." The high frequency of sugar items suggests that Instacart users are regularly purchasing core ingredients for homemade baking.

Pet Care is Low Volume and Treat-Focused: The "dog food care" aisle shows significantly lower order counts compared to the other two aisles (the top item, "Snack Sticks Chicken & Rice Recipe Dog Treats," has only 30 orders). This low volume might indicate that customers frequently purchase bulky dog food elsewhere, using Instacart mainly for small, specialized items like treats and biscuits.

Packaged Produce is Highly Organic and Berry-Driven: The "packaged vegetables fruits" aisle has very high order counts, consistent with the overall dataset's popularity of produce. The three most popular items—"Organic Baby Spinach," "Organic Raspberries," and "Organic Blueberries"—are all organic, suggesting a strong preference for organic options in this convenient, pre-packaged category.

## The mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week.
```{r}
instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  group_by(product_name, order_dow) |> 
  summarize(mean_hour = mean(order_hour_of_day)) |> 
  pivot_wider(names_from = order_dow, values_from = mean_hour) |> 
  knitr::kable(digits = 2)

```

The table indicates that, on average, Coffee Ice Cream is ordered later in the day than Pink Lady Apples across all days of the week. Both products tend to be ordered in the early to mid-afternoon (13:00-15:00).


# Problem 2

## Tidy the data
```{r}
zori_file <- "data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv"
zip_file  <- "data/zillow_data/Zip Codes.csv"

zori_df <- read_csv(zori_file) |> 
  pivot_longer(
    cols = matches("^20"),   
    names_to = "month",
    values_to = "rent" # Renamed to 'rent' for clarity
  ) |> 
  mutate(
    month = ymd(month),      
    year = year(month)
  )

zip_df <- read_csv(zip_file) |> 
  janitor::clean_names() |> 
  distinct(zip_code, .keep_all = TRUE)

# Join the data
zillow_df <- zori_df |> 
  left_join(zip_df, by = c("RegionName" = "zip_code")) |> 
  arrange(RegionName, month) |>

  filter(!is.na(county)) |>
  rename(borough = county, zip_code = RegionName) 

```

## Number of ZIP codes observed

```{r}

total_months <- n_distinct(zillow_df$month)

zip_summary <- zillow_df |>
  count(zip_code) |>
  summarise(
    total_unique_months = total_months,
    zips_observed_all_months = sum(n == total_months),
    zips_observed_rarely = sum(n < 10)
  )

kable(zip_summary)
```

Some ZIP codes are observed in each month: These are areas with highly active, stable rental markets and large transaction volumes. They provide consistent, reliable data for monthly price calculation.

Rare observations typically occur in low-activity rental markets. 

## The average rental price in each borough and year
```{r}
avg_rent_table <- zillow_df |>
  group_by(borough, year) |>
  summarise(avg_rent = mean(rent, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = year, values_from = avg_rent)

kable(avg_rent_table, digits = 0)
```

There is a consistent and significant upward trend in rental prices across all boroughs from 2015 to 2024. Most boroughs saw their average rents increase by several hundred dollars over the decade.

New York (Manhattan) is consistently the most expensive borough by a large margin, followed by Kings (Brooklyn), Queens, and then the Bronx.

A noticeable dip or stagnation in rental prices occurred in 2020 and 2021 for most boroughs, including New York, Kings, and Queens. This deviation from the growth trend likely reflects the initial impact of the COVID-19 pandemic on the rental market. The Bronx is a notable exception, as its rent continued to rise steadily during this period.

Beginning in 2022, the market experienced a dramatic surge in rental prices across all boroughs. This indicates a strong and rapid recovery, with rents quickly surpassing pre-pandemic levels.

## NYC Rental Prices within ZIP Codes Over Time

```{r}

borough_median_rent <- zillow_df |>
  group_by(borough, month) |>
  summarise(
    median_rent = median(rent, na.rm = TRUE),
    .groups = "drop"
  )

plot_rent_ts <- zillow_df |>
  ggplot(aes(x = month, y = rent)) + 
  geom_line(aes(group = zip_code), alpha = 0.5, color = "grey50") + 
  

  geom_line(
    data = borough_median_rent, 
    aes(y = median_rent, color = borough, group = borough), 
    linewidth = 1.2
  ) +

  facet_wrap(~ borough, scales = "free_y", ncol = 1) + 
  
  labs(
    title = "NYC Rental Prices", 
    x = "Year", 
    y = "Monthly Rent ($)",
    color = "Borough Median" 
  ) + 
  theme_minimal() +
  theme(legend.position = "bottom")

plot_rent_ts
```

New York (Manhattan) consistently holds the highest median rent, followed by Kings (Brooklyn) and Queens. Bronx and Richmond (Staten Island) remain the most affordable.

Manhattan's Extreme Volatility and Recovery: Manhattan shows the most dramatic movement. The colored median line clearly captures the sharp decline around 2020-2021 (COVID-19 impact), followed by an extremely steep, V-shaped recovery that pushes the median rent above pre-pandemic levels by 2024.

Heterogeneity within Boroughs (The Grey Lines): The grey lines demonstrate the internal variability:

New York has the widest gap between its lowest and highest-rent ZIP codes, indicated by the broad spread of the grey lines above and below the median.

Bronx and Richmond show the tightest clustering, meaning their ZIP codes have more uniform rental prices.

The median trend lines confirm that all boroughs experienced a dip or stagnation during the pandemic, although the magnitude of the dip was far greater in Manhattan than in the other four boroughs.

## The average rental price within each ZIP code over each month in 2023

```{r}
plot_rent_dist <- zillow_df |>
  filter(year == 2023) |>
  group_by(borough, zip_code) |>
  summarise(avg_rent_2023 = mean(rent, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = fct_reorder(borough, avg_rent_2023), y = avg_rent_2023, fill = borough)) +
  geom_boxplot() +
  labs(title = "Distribution of Rental Prices in 2023", x = "Borough", y = "Average Rent") +
  theme_minimal() +
  theme(legend.position = "none")
plot_rent_dist
```

The plot shows a distinct tiered structure in median rental prices. 

Manhattan (New York) has the highest median rent by a significant margin, followed by Brooklyn (Kings), and then Queens. The Bronx and Staten Island (Richmond) have the lowest median rents and are very comparable to each other.

There are major differences in the range of rental prices within each borough. 

Manhattan and Brooklyn display very wide distributions, evidenced by their large boxes and long whiskers. This indicates a substantial price gap between their most and least expensive neighborhoods. In contrast, the Bronx, Queens, and Staten Island have much more compressed distributions, suggesting more uniform rental prices across their respective ZIP codes.

The individual points above the whiskers signify outlier ZIP codes with exceptionally high rents. 

Manhattan has the most numerous and extreme outliers, with some average rents far exceeding $5,000. This highlights the presence of super-premium neighborhoods within the borough. Brooklyn also has several high-priced outliers.

```{r}
if (!dir.exists("results")) dir.create("results")
ggsave("results/zillow_analysis.png", plot_rent_ts / plot_rent_dist, width = 6, height = 12)
```

# Problem 3

## Tidy the data 
```{r}

nhanes_df <- 
  inner_join(
    read_csv("./data/nhanes_covar.csv", skip = 4),
    read_csv("./data/nhanes_accel.csv"),
    by = "SEQN"
  ) |>
  filter(age >= 21) |>
  drop_na(sex, age, education, BMI) |>
  mutate(
    sex = factor(
      sex,
      levels = c(1, 2),
      labels = c("Male", "Female")
      ),
    education = factor(
      education,
      levels = c(1, 2, 3),
      labels = c("Less than high school", "High school equivalent", "More than high school"),
      ordered = TRUE
    )
  )
```

## The number of men and women in each education category

```{r}
nhanes_df |>
  count(education, sex) |>
  pivot_wider(names_from = sex, values_from = n) |>
  kable(caption = "Number of Participants by Education and Sex")

```

The largest single group of participants for both men and women falls into the "More than high school" category (56 males, 59 females), indicating that the sample is primarily composed of individuals with higher levels of education.

The sample shows near-perfect gender parity in the lowest educational category, "Less than high school" (27 males vs. 28 females), and also in the highest category, "More than high school" (56 males vs. 59 females).

The most notable gender difference occurs in the "High school equivalent" category, where males (35) significantly outnumber females (23). This difference accounts for the slight overall male majority in the total sample size across these three categories.

## Visualization of the age distributions

```{r}
nhanes_df |>
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ education, nrow = 2) +
  labs(
    title = "Age Distribution by Sex and Education", 
    x = "Age", 
    y = "Density",
    fill = "Sex"
  ) +
  theme_minimal()
```

The figure displays the age distributions of participants by education level and sex. 

Among individuals with less than a high school education, most participants are middle-aged to older adults, with both sexes showing similar age profiles. 

For those with a high school equivalent education, males appear slightly more concentrated in midlife, while females show a broader age spread extending toward older ages. 

In the group with more than a high school education, the distribution is shifted toward younger ages, particularly among females, indicating that higher education levels are more common in younger participants. Overall, the plot suggests that education level is inversely associated with age in this sample.

## Total activities against age

```{r}

minute_data <- select(nhanes_df, starts_with("min"))

total_activity_vector <- rowSums(minute_data, na.rm = TRUE)

nhanes_df <- mutate(nhanes_df, total_activity = total_activity_vector)

ggplot(nhanes_df, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~ education, nrow = 2) +
  labs(title = "Total Daily Activity vs. Age", y = "Total Activity", color = "Sex") +
  theme_minimal()

```

The figure shows the relationship between total daily activity and age, stratified by education level and sex. Across all education levels, total activity decreases with increasing age, indicating that older individuals tend to have lower overall physical activity. The negative slopes of the regression lines are consistent in all panels.

Within each education group, females generally show slightly higher total activity than males at similar ages, though the difference is modest. The decline in activity with age appears steepest among individuals with less than a high school education, while the relationship is somewhat weaker among those with higher education, suggesting that higher education may be associated with maintaining activity levels into older age.

## 24-hour activity time courses

```{r}
nhanes_df |>
  pivot_longer(
    cols = starts_with("min"), 
    names_to = "minute_str",
    values_to = "mims_value" 
  ) |>
  mutate(minute = as.numeric(str_extract(minute_str, "\\d+"))) |>
  group_by(education, sex, minute) |>
  summarise(mean_mims = mean(mims_value, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = minute, y = mean_mims, color = sex)) +
  geom_line(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_wrap(~ education, nrow = 4) +
  labs(title = "24-Hour Activity Pattern by Education", x = "Minute of Day", y = "Mean Activity", color = "Sex") +
  theme_minimal()

```

The figure displays the 24-hour activity patterns separated by education level (less than high school, high school equivalent, and more than high school), with sex indicated by color. Across all three panels, activity levels show a clear diurnal rhythm: activity is lowest during the early morning hours, rises sharply after waking (around 300–500 minutes of the day), peaks near midday, and gradually declines during the evening.

Individuals with higher education tend to exhibit slightly higher overall mean activity throughout the day compared to those with less education. In particular, participants with more than high school education show an earlier and sharper rise in activity levels in the morning.

When comparing sexes, females generally show slightly higher mean activity than males at most times of the day across all education levels. The smoothed curves indicate that while the overall daily pattern is similar, differences in activity magnitude by sex and education are consistent and persistent throughout the 24-hour cycle.





